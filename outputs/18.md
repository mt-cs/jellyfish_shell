## Test 18: Memory Leak Check [1 pts]

```

if ! ( which valgrind &> /dev/null ); then
    # "valgrind is not installed. Please install (as root) with:"
    # "pacman -Sy valgrind"
    test_end 1
fi

leak_output=$(timeout 10 valgrind \
    --trace-children=no \
    --child-silent-after-fork=yes \
    --leak-check=full \
    --track-fds=yes \
    --show-leak-kinds=all \
    --track-origins=yes \
    ./$SHELL_NAME < <(echo "${script}") 2>&1)

echo "${leak_output}"
==1351985== Memcheck, a memory error detector
==1351985== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==1351985== Using Valgrind-3.16.1 and LibVEX; rerun with -h for copyright info
==1351985== Command: ./jellyfish
==1351985== 
elist.c:52:elist_create(): Initializing new elist: capacity=[10], item_sz=[260], bytes=[2600]
elist.c:52:elist_create(): Initializing new elist: capacity=[10], item_sz=[8], bytes=[80]
==1351985== Invalid read of size 8
==1351985==    at 0x484555F: memmove (vg_replace_strmem.c:1270)
==1351985==    by 0x10BA28: clist_add (clist.c:60)
==1351985==    by 0x10A4F8: hist_add (history.c:34)
==1351985==    by 0x10B13B: jellyfish_process_command (shell.c:285)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985==  Address 0x4c428e8 is 3 bytes after a block of size 5 alloc'd
==1351985==    at 0x483E77F: malloc (vg_replace_malloc.c:307)
==1351985==    by 0x4A855BE: strdup (in /usr/lib/libc-2.33.so)
==1351985==    by 0x10A4DE: hist_add (history.c:33)
==1351985==    by 0x10B13B: jellyfish_process_command (shell.c:285)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985== 
==1351985== Invalid read of size 8
==1351985==    at 0x4845567: memmove (vg_replace_strmem.c:1270)
==1351985==    by 0x10BA28: clist_add (clist.c:60)
==1351985==    by 0x10A4F8: hist_add (history.c:34)
==1351985==    by 0x10B13B: jellyfish_process_command (shell.c:285)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985==  Address 0x4c428f0 is 11 bytes after a block of size 5 alloc'd
==1351985==    at 0x483E77F: malloc (vg_replace_malloc.c:307)
==1351985==    by 0x4A855BE: strdup (in /usr/lib/libc-2.33.so)
==1351985==    by 0x10A4DE: hist_add (history.c:33)
==1351985==    by 0x10B13B: jellyfish_process_command (shell.c:285)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985== 
==1351985== Invalid read of size 8
==1351985==    at 0x484556F: memmove (vg_replace_strmem.c:1270)
==1351985==    by 0x10BA28: clist_add (clist.c:60)
==1351985==    by 0x10A4F8: hist_add (history.c:34)
==1351985==    by 0x10B13B: jellyfish_process_command (shell.c:285)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985==  Address 0x4c428f8 is 19 bytes after a block of size 5 alloc'd
==1351985==    at 0x483E77F: malloc (vg_replace_malloc.c:307)
==1351985==    by 0x4A855BE: strdup (in /usr/lib/libc-2.33.so)
==1351985==    by 0x10A4DE: hist_add (history.c:33)
==1351985==    by 0x10B13B: jellyfish_process_command (shell.c:285)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985== 
==1351985== Invalid read of size 8
==1351985==    at 0x4845554: memmove (vg_replace_strmem.c:1270)
==1351985==    by 0x10BA28: clist_add (clist.c:60)
==1351985==    by 0x10A4F8: hist_add (history.c:34)
==1351985==    by 0x10B13B: jellyfish_process_command (shell.c:285)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985==  Address 0x4c42900 is 16 bytes after a block of size 16 in arena "client"
==1351985== 
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
==1351985== Syscall param chdir(path) points to unaddressable byte(s)
==1351985==    at 0x4AE69DB: chdir (in /usr/lib/libc-2.33.so)
==1351985==    by 0x10A880: jellyfish_cd (shell.c:98)
==1351985==    by 0x10B01A: jellyfish_built_in (shell.c:256)
==1351985==    by 0x10B1CB: jellyfish_process_command (shell.c:311)
==1351985==    by 0x10B294: main (shell.c:336)
==1351985==  Address 0x0 is not stack'd, malloc'd or (recently) free'd
==1351985== 
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
bin
boot
dev
etc
home
lib
lib64
mnt
opt
proc
repos
root
run
sbin
srv
sys
tmp
usr
var
vm-status
execvp: No such file or directory
/home/mmalensek
hi
1 ls /
2 ls /
3 jobs
4 cd
5 ls / # Doing some more lsing
6 ls / # Doing some more lsing
7 asdfghjklqprewopiqwualasdf # Bad Command!
8 # Comment only
9 pwd
10 echo hi
11 sort -r -n < /etc/passwd > /tmp/22427
12 rm /tmp/22427
13 history
/home/mmalensek
bye
getline: No child processes
==1351985== 
==1351985== FILE DESCRIPTORS: 4 open at exit.
==1351985== Open file descriptor 63:
==1351985==    <inherited from parent>
==1351985== 
==1351985== Open file descriptor 2:
==1351985==    <inherited from parent>
==1351985== 
==1351985== Open file descriptor 1:
==1351985==    <inherited from parent>
==1351985== 
==1351985== Open file descriptor 0:
==1351985==    <inherited from parent>
==1351985== 
==1351985== 
==1351985== HEAP SUMMARY:
==1351985==     in use at exit: 0 bytes in 0 blocks
==1351985==   total heap usage: 90 allocs, 90 frees, 51,700 bytes allocated
==1351985== 
==1351985== All heap blocks were freed -- no leaks are possible
==1351985== 
==1351985== For lists of detected and suppressed errors, rerun with: -s
==1351985== ERROR SUMMARY: 448 errors from 5 contexts (suppressed: 0 from 0)

# Check for open FDs
awk "${fd_check}" <<< "${leak_output}" \
    | grep -i '==[0-9]*==.*file descriptor' && test_end 1

# Make sure there were no leaks possible
grep -i '==[0-9]*==.*no leaks are possible' \
    <<< "${leak_output}" || test_end 1
==1351985== All heap blocks were freed -- no leaks are possible

# If none of the conditions were triggered above, the test passes.
test_end 0
```

